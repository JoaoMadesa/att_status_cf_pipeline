name: Madesa Status Pipeline

on:
  schedule:
    - cron: "50 8 * * *"
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install pandas openpyxl requests google-api-python-client google-auth pyarrow

      - name: Restore incremental state (last_run + base parquet)
        uses: actions/cache@v4
        with:
          path: |
            out_status/last_run.txt
            out_status/base_status.parquet
          key: madesa-status-historico

      - name: Run pipeline
        env:
          CF_EMAIL: ${{ secrets.CF_EMAIL }}
          CF_SENHA: ${{ secrets.CF_SENHA }}
          CF_IDCLIENTE: "206"
          CF_IDPRODUTO: "1"
          LOOKBACK_DIAS: "15"

          GOOGLE_CREDENTIALS_PATH: ${{ github.workspace }}/secrets/gsa.json
          SHEET_ID: ${{ secrets.SHEET_ID }}

          OUTPUT_DIR: ${{ github.workspace }}/out_status
          DEXPARA_XLSX_PATH: ${{ github.workspace }}/data/DExPARA.xlsx
        run: |
          python processoAtt.py
