name: Madesa Status Pipeline

on:
  schedule:
    - cron: "45 9 * * *"
  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Create requirements
        run: |
          cat > requirements.txt << 'EOF'
          google-api-python-client==2.138.0
          google-auth==2.33.0
          google-auth-httplib2==0.2.0
          pandas==2.2.2
          openpyxl==3.1.5
          requests==2.32.3
          urllib3==2.2.2
          EOF
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Escreve as credenciais se GSA_JSON_B64 estiver definido (sem usar if: no YAML)
      - name: Write Google credentials (base64 -> arquivo, se houver)
        run: |
          mkdir -p "${{ github.workspace }}/secrets"
          if [ -n "${{ secrets.GSA_JSON_B64 }}" ]; then
            echo "${{ secrets.GSA_JSON_B64 }}" | base64 -d > "${{ github.workspace }}/secrets/gsa.json"
            echo "Credenciais gravadas a partir de GSA_JSON_B64."
          else
            echo "GSA_JSON_B64 não definido. Se GOOGLE_CREDENTIALS_JSON estiver definido, o script usará inline."
          fi

      - name: Pre-run checks
        run: |
          # Verifica se temos OU o arquivo decodificado OU o JSON inline
          if [ -s "${{ github.workspace }}/secrets/gsa.json" ]; then
            echo "OK: arquivo de credenciais presente."
          elif [ -n "${{ secrets.GOOGLE_CREDENTIALS_JSON }}" ]; then
            echo "OK: GOOGLE_CREDENTIALS_JSON (inline) será usado pelo script."
          else
            echo "ERRO: Nenhuma credencial do Google informada (nem GSA_JSON_B64 nem GOOGLE_CREDENTIALS_JSON)."
            exit 1
          fi
          # Checa o DExPARA.xlsx
          test -s "${{ github.workspace }}/data/DExPARA.xlsx" || (echo "ERRO: data/DExPARA.xlsx não encontrado" && exit 1)

      - name: Run pipeline
        env:
          CF_EMAIL: ${{ secrets.CF_EMAIL }}
          CF_SENHA: ${{ secrets.CF_SENHA }}
          CF_IDCLIENTE: "206"
          CF_IDPRODUTO: "1"
          LOOKBACK_DIAS: "30"
          # Google creds: arquivo (se criado) OU JSON inline (ambos suportados pelo script)
          GOOGLE_CREDENTIALS_PATH: ${{ github.workspace }}/secrets/gsa.json
          GOOGLE_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CREDENTIALS_JSON }}
          SHEET_ID: ${{ secrets.SHEET_ID }}
          OUTPUT_DIR: ${{ github.workspace }}/out_status
          DEXPARA_XLSX_PATH: ${{ github.workspace }}/data/DExPARA.xlsx
        run: |
          python pipeline_cf_status.py --run --lookback "${LOOKBACK_DIAS}"

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: saida
          if-no-files-found: ignore
          path: |
            out_status/ENTREGUES.csv
            out_status/CANCELADOS.csv
            out_status/DADOS CONFIRMADOS.csv
            out_status/CONTATOS CONFIRMADOS.csv
            out_status/ATUALIZACAO_DE_STATUS.xlsx
